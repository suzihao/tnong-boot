<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tnong.boot.system.log.mapper.SysOperLogMapper">

    <resultMap id="BaseResultMap" type="com.tnong.boot.system.log.domain.entity.SysOperLog">
        <id property="id" column="id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="module" column="module"/>
        <result property="businessType" column="business_type"/>
        <result property="requestMethod" column="request_method"/>
        <result property="requestUrl" column="request_url"/>
        <result property="requestIp" column="request_ip"/>
        <result property="userAgent" column="user_agent"/>
        <result property="method" column="method"/>
        <result property="requestParams" column="request_params"/>
        <result property="responseData" column="response_data"/>
        <result property="status" column="status"/>
        <result property="errorMsg" column="error_msg"/>
        <result property="costTime" column="cost_time"/>
        <result property="operTime" column="oper_time"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, tenant_id, user_id, username, module, business_type, request_method, request_url,
        request_ip, user_agent, method, request_params, response_data, status, error_msg, cost_time, oper_time
    </sql>

    <sql id="Common_Where_Clause">
        <where>
            <if test="tenantId != null">
                AND tenant_id = #{tenantId}
            </if>
            <if test="query != null">
                <if test="query.module != null and query.module != ''">
                    AND module LIKE CONCAT('%', #{query.module}, '%')
                </if>
                <if test="query.username != null and query.username != ''">
                    AND username LIKE CONCAT('%', #{query.username}, '%')
                </if>
                <if test="query.businessType != null">
                    AND business_type = #{query.businessType}
                </if>
                <if test="query.status != null">
                    AND status = #{query.status}
                </if>
                <if test="query.beginTime != null">
                    AND oper_time &gt;= #{query.beginTime}
                </if>
                <if test="query.endTime != null">
                    AND oper_time &lt;= #{query.endTime}
                </if>
            </if>
        </where>
    </sql>

    <!-- 插入操作日志 -->
    <insert id="insert" parameterType="com.tnong.boot.system.log.domain.entity.SysOperLog"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_oper_log (
            tenant_id, user_id, username, module, business_type, request_method, request_url,
            request_ip, user_agent, method, request_params, response_data, status, error_msg, cost_time, oper_time
        ) VALUES (
            #{tenantId}, #{userId}, #{username}, #{module}, #{businessType}, #{requestMethod}, #{requestUrl},
            #{requestIp}, #{userAgent}, #{method}, #{requestParams}, #{responseData}, #{status}, #{errorMsg}, #{costTime}, NOW()
        )
    </insert>

    <!-- 分页查询列表 -->
    <select id="selectPageList" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_oper_log
        <include refid="Common_Where_Clause"/>
        ORDER BY oper_time DESC
        LIMIT #{query.offset}, #{query.size}
    </select>

    <!-- 查询总数 -->
    <select id="selectCount" resultType="long">
        SELECT COUNT(*)
        FROM sys_oper_log
        <include refid="Common_Where_Clause"/>
    </select>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_oper_log
        WHERE id = #{id}
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
    </select>

    <!-- 批量删除 -->
    <delete id="deleteByIds">
        DELETE FROM sys_oper_log
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
    </delete>

    <!-- 清空日志 -->
    <delete id="truncate">
        DELETE FROM sys_oper_log
        <where>
            <if test="tenantId != null">
                AND tenant_id = #{tenantId}
            </if>
        </where>
    </delete>

</mapper>
