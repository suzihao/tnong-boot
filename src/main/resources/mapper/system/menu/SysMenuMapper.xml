<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tnong.boot.system.menu.mapper.SysMenuMapper">

    <select id="selectById" resultType="com.tnong.boot.system.menu.domain.entity.SysMenu">
        SELECT * FROM sys_menu WHERE id = #{id} AND tenant_id = #{tenantId} AND delete_flag = 0
    </select>

    <select id="selectList" resultType="com.tnong.boot.system.menu.domain.entity.SysMenu">
        SELECT * FROM sys_menu WHERE tenant_id = #{tenantId} AND delete_flag = 0 ORDER BY sort ASC, created_time ASC
    </select>

    <select id="selectByParentId" resultType="com.tnong.boot.system.menu.domain.entity.SysMenu">
        SELECT * FROM sys_menu WHERE parent_id = #{parentId} AND tenant_id = #{tenantId} AND delete_flag = 0 ORDER BY sort ASC
    </select>

    <select id="selectByRoleId" resultType="com.tnong.boot.system.menu.domain.entity.SysMenu">
        SELECT m.* FROM sys_menu m
        INNER JOIN sys_role_menu rm ON m.id = rm.menu_id
        WHERE rm.role_id = #{roleId} AND m.tenant_id = #{tenantId} AND m.delete_flag = 0 AND rm.delete_flag = 0
        ORDER BY m.sort ASC
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_menu (tenant_id, parent_id, type, name, path, component, perms, icon, sort, visible, status, remark, delete_flag, created_time, created_user, updated_time, updated_user, version)
        VALUES (#{tenantId}, #{parentId}, #{type}, #{name}, #{path}, #{component}, #{perms}, #{icon}, #{sort}, #{visible}, #{status}, #{remark}, 0, NOW(), #{createdUser}, NOW(), #{updatedUser}, 0)
    </insert>

    <update id="updateByIdWithVersion">
        UPDATE sys_menu
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="type != null">type = #{type},</if>
            <if test="path != null">path = #{path},</if>
            <if test="component != null">component = #{component},</if>
            <if test="perms != null">perms = #{perms},</if>
            <if test="icon != null">icon = #{icon},</if>
            <if test="sort != null">sort = #{sort},</if>
            <if test="visible != null">visible = #{visible},</if>
            <if test="status != null">status = #{status},</if>
            <if test="remark != null">remark = #{remark},</if>
            updated_time = NOW(), updated_user = #{updatedUser}, version = version + 1
        </set>
        WHERE id = #{id} AND tenant_id = #{tenantId} AND version = #{version} AND delete_flag = 0
    </update>

    <update id="deleteById">
        UPDATE sys_menu SET delete_flag = 1, updated_time = NOW(), updated_user = #{updatedUser}, version = version + 1
        WHERE id = #{id} AND tenant_id = #{tenantId} AND version = #{version} AND delete_flag = 0
    </update>

</mapper>
