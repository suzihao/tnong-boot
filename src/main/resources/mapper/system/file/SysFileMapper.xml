<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tnong.boot.system.file.mapper.SysFileMapper">

    <select id="selectById" resultType="com.tnong.boot.system.file.domain.entity.SysFile">
        SELECT * FROM sys_file WHERE id = #{id} AND tenant_id = #{tenantId} AND delete_flag = 0
    </select>

    <select id="selectByMd5" resultType="com.tnong.boot.system.file.domain.entity.SysFile">
        SELECT * FROM sys_file WHERE md5 = #{md5} AND tenant_id = #{tenantId} AND delete_flag = 0 LIMIT 1
    </select>

    <select id="selectPageList" resultType="com.tnong.boot.system.file.domain.entity.SysFile">
        SELECT * FROM sys_file
        WHERE tenant_id = #{tenantId} AND delete_flag = 0
        <if test="query.fileName != null and query.fileName != ''">
            AND file_name LIKE CONCAT('%', #{query.fileName}, '%')
        </if>
        <if test="query.storageType != null">
            AND storage_type = #{query.storageType}
        </if>
        <if test="query.bizType != null and query.bizType != ''">
            AND biz_type = #{query.bizType}
        </if>
        <if test="query.bizId != null">
            AND biz_id = #{query.bizId}
        </if>
        ORDER BY created_time DESC
        LIMIT #{query.offset}, #{query.size}
    </select>

    <select id="selectCount" resultType="java.lang.Long">
        SELECT COUNT(*) FROM sys_file
        WHERE tenant_id = #{tenantId} AND delete_flag = 0
        <if test="query.fileName != null and query.fileName != ''">
            AND file_name LIKE CONCAT('%', #{query.fileName}, '%')
        </if>
        <if test="query.storageType != null">
            AND storage_type = #{query.storageType}
        </if>
        <if test="query.bizType != null and query.bizType != ''">
            AND biz_type = #{query.bizType}
        </if>
        <if test="query.bizId != null">
            AND biz_id = #{query.bizId}
        </if>
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_file (tenant_id, file_name, file_suffix, content_type, file_size, storage_type, bucket, object_key, url, biz_type, biz_id, md5, status, remark, delete_flag, created_time, created_user, updated_time, updated_user, version)
        VALUES (#{tenantId}, #{fileName}, #{fileSuffix}, #{contentType}, #{fileSize}, #{storageType}, #{bucket}, #{objectKey}, #{url}, #{bizType}, #{bizId}, #{md5}, #{status}, #{remark}, 0, NOW(), #{createdUser}, NOW(), #{updatedUser}, 0)
    </insert>

    <update id="updateByIdWithVersion">
        UPDATE sys_file
        <set>
            <if test="bizType != null">biz_type = #{bizType},</if>
            <if test="bizId != null">biz_id = #{bizId},</if>
            <if test="remark != null">remark = #{remark},</if>
            updated_time = NOW(), updated_user = #{updatedUser}, version = version + 1
        </set>
        WHERE id = #{id} AND tenant_id = #{tenantId} AND version = #{version} AND delete_flag = 0
    </update>

    <update id="deleteById">
        UPDATE sys_file SET delete_flag = 1, updated_time = NOW(), updated_user = #{updatedUser}, version = version + 1
        WHERE id = #{id} AND tenant_id = #{tenantId} AND version = #{version} AND delete_flag = 0
    </update>

</mapper>
